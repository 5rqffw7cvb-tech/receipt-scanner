(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))i(c);new MutationObserver(c=>{for(const o of c)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function n(c){const o={};return c.integrity&&(o.integrity=c.integrity),c.referrerPolicy&&(o.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?o.credentials="include":c.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(c){if(c.ep)return;c.ep=!0;const o=n(c);fetch(c.href,o)}})();let A=null;async function Y(){return A||(A=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=()=>{window.cv&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>t():t()},n.onerror=i=>e(new Error("Failed to load OpenCV.js")),document.head.appendChild(n)}),A)}const q=[];function T(t){return q.push(t),t}function J(){try{q.forEach(t=>t.delete())}catch{}q.length=0}async function Z(t,e){const{canny1:n=50,canny2:i=150,minAreaRatio:c=.15}=e||{},o=cv.imread(t),p=T(new cv.Mat);cv.cvtColor(o,p,cv.COLOR_RGBA2GRAY);const s=T(new cv.Mat);cv.GaussianBlur(p,s,new cv.Size(5,5),0);const r=T(new cv.Mat);cv.Canny(s,r,n,i);const w=cv.Mat.ones(3,3,cv.CV_8U),m=T(new cv.Mat);cv.dilate(r,m,w),w.delete();const f=new cv.MatVector,C=new cv.Mat;cv.findContours(m,f,C,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),C.delete();const y=o.rows*o.cols;let d=null;for(let g=0;g<f.size();g++){const M=f.get(g);if(cv.contourArea(M)<y*c){M.delete();continue}const O=cv.arcLength(M,!0),x=new cv.Mat;if(cv.approxPolyDP(M,x,.02*O,!0),x.rows===4){const R=[];for(let B=0;B<4;B++)R.push({x:x.intPtr(B,0)[0],y:x.intPtr(B,0)[1]});d=_(R),x.delete(),M.delete();break}x.delete(),M.delete()}return f.delete(),o.delete(),d?{quad:d}:null}function _(t){const e=t.map(s=>({p:s,s:s.x+s.y})).sort((s,r)=>s.s-r.s),n=t.map(s=>({p:s,d:s.x-s.y})).sort((s,r)=>s.d-r.d),i=e[0].p,c=e[3].p,o=n[3].p,p=n[0].p;return[i,o,c,p]}async function tt(t,e,n){const{scalePreviewToOriginal:i=1,maxOutputWidth:c=1600}=n||{},o=i,p=e.map(L=>({x:L.x*o,y:L.y*o})),s=cv.imread(t),r=_(p),w=j(r[0],r[1]),m=j(r[3],r[2]),f=j(r[0],r[3]),C=j(r[1],r[2]);let y=Math.max(w,m),d=Math.max(f,C);if(y>c){const L=c/y;y=c,d=Math.round(d*L)}const g=new cv.Size(Math.max(4,Math.round(y)),Math.max(4,Math.round(d))),M=cv.matFromArray(4,1,cv.CV_32FC2,r.flatMap(L=>[L.x,L.y])),z=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,g.width,0,g.width,g.height,0,g.height]),O=cv.getPerspectiveTransform(M,z),x=new cv.Mat;cv.warpPerspective(s,x,O,g,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);const R=document.createElement("canvas");return R.width=g.width,R.height=g.height,cv.imshow(R,x),s.delete(),M.delete(),z.delete(),O.delete(),x.delete(),{canvas:R}}function j(t,e){const n=t.x-e.x,i=t.y-e.y;return Math.hypot(n,i)}let l,u,k,h=null,E=-1;function et(t){l=t,u=l.getContext("2d"),l.addEventListener("pointerdown",it),l.addEventListener("pointermove",rt),l.addEventListener("pointerup",N),l.addEventListener("pointercancel",N)}function nt(t){k=t,l.width=k.width,l.height=k.height,F()}function S(t){h=t.map(e=>({x:e.x,y:e.y})),F()}function ot(){return h?h.map(t=>({x:t.x,y:t.y})):null}function F(){if(!(!u||!k)&&(u.clearRect(0,0,l.width,l.height),!!h)){u.strokeStyle="#10b981",u.lineWidth=2,u.beginPath(),u.moveTo(h[0].x,h[0].y),u.lineTo(h[1].x,h[1].y),u.lineTo(h[2].x,h[2].y),u.lineTo(h[3].x,h[3].y),u.closePath(),u.stroke();for(let t=0;t<4;t++)at(h[t].x,h[t].y)}}function at(t,e){u.fillStyle="#10b981",u.strokeStyle="#065f46",u.lineWidth=2,u.beginPath(),u.arc(t,e,8,0,Math.PI*2),u.fill(),u.stroke()}function ct(t,e){if(!h)return-1;for(let n=0;n<4;n++){const i=h[n].x-t,c=h[n].y-e;if(Math.hypot(i,c)<=12)return n}return-1}function it(t){const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),i=(t.clientY-e.top)*(l.height/e.height);E=ct(n,i),E!==-1&&(l.setPointerCapture(t.pointerId),t.preventDefault())}function rt(t){if(E===-1)return;const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),i=(t.clientY-e.top)*(l.height/e.height);h[E].x=Math.max(0,Math.min(l.width,n)),h[E].y=Math.max(0,Math.min(l.height,i)),F()}function N(t){E!==-1&&l.releasePointerCapture(t.pointerId),E=-1}async function Q(t,e=.75,n=500,i=1600){let c=e,o=t;const p=(f,C)=>new Promise(y=>f.toBlob(d=>y(d),"image/jpeg",C)),s=async(f,C)=>{const y=await p(f,C),d=y.size;return{blob:y,size:d}};let{blob:r,size:w}=await s(o,c),m=0;for(;w>n*1024&&m<12;){if(m++,c>.5)c=Math.max(.4,c-.07);else{const C=Math.max(320,Math.round(o.width*.9)),y=Math.round(o.height*.9),d=document.createElement("canvas");d.width=Math.min(i,C),d.height=Math.round(y*(d.width/o.width)),d.getContext("2d").drawImage(o,0,0,d.width,d.height),o=d}const f=await s(o,c);r=f.blob,w=f.size}return{blob:r,size:w,quality:c}}const a={targetWidth:1280,canny1:30,canny2:100,minContourAreaRatio:.08,jpegQuality:.75,sizeLimitKB:500,maxOutputWidth:1600,cvReady:!1,imageBitmap:null,originalCanvas:null,scale:1,quadPreview:null,croppedCanvas:null},v=t=>document.getElementById(t),st=v("status"),$=v("cameraInput"),U=v("galleryInput"),lt=v("cameraBtn"),dt=v("galleryBtn"),I=v("previewCanvas"),ut=v("overlayCanvas"),K=v("resultSection"),D=v("resultImg"),W=v("adjustControls"),V=v("outputControls"),G=v("qualitySlider"),ht=v("downloadBtn"),X=v("sizeInfo"),pt=v("resetCorners"),vt=v("applyCrop"),mt=v("backBtn");function P(t){st.textContent=t}function b(t,e){t.classList.toggle("hidden",!e)}async function ft(){try{const e=await(await fetch("/package.json")).json();document.getElementById("version").textContent="v"+e.version}catch{console.log("Could not load version")}}ft();async function yt(){a.cvReady||(P("Loading OpenCV…"),await Y(),a.cvReady=!0,P("OpenCV ready"))}async function gt(){$.click()}async function wt(){U.click()}async function H(t){var w;const e=(w=t.target.files)==null?void 0:w[0];if(!e)return;b(K,!1),b(W,!1),b(V,!1),b(previewSection,!0),await yt(),P("Xử lý…");const n=await createImageBitmap(e);a.imageBitmap=n;const i=document.createElement("canvas");i.width=n.width,i.height=n.height,i.getContext("2d").drawImage(n,0,0),a.originalCanvas=i,a.targetWidth/n.width;const o=Math.min(a.targetWidth,n.width),p=Math.round(n.height*(o/n.width));I.width=o,I.height=p,I.getContext("2d").drawImage(n,0,0,o,p),a.scale=o/n.width;let r=null;try{const m=await Z(I,{canny1:a.canny1,canny2:a.canny2,minAreaRatio:a.minContourAreaRatio});r=(m==null?void 0:m.quad)||null}catch(m){console.error(m)}finally{J()}if(et(ut),nt(I),r)S(r),a.quadPreview=r,P("Đã phát hiện. Chỉnh nếu cần.");else{const m=[{x:10,y:10},{x:o-10,y:10},{x:o-10,y:p-10},{x:10,y:p-10}];S(m),a.quadPreview=m,P("Không tìm được biên, vui lòng chỉnh tay.")}b(W,!0)}async function Ct(){const t=ot();a.quadPreview=t,P("Đang cắt…");const{canvas:e}=await tt(a.originalCanvas,t,{scalePreviewToOriginal:1/a.scale,maxOutputWidth:a.maxOutputWidth});a.croppedCanvas=e;const n=await Q(e,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),i=URL.createObjectURL(n.blob);D.src=i,b(K,!0),b(V,!0),X.textContent=`Kích thước: ${Math.round(n.size/1024)}KB | Chất lượng: ${n.quality.toFixed(2)} | Rộng: ${e.width}px`,P("Hoàn thành")}async function xt(){if(a.jpegQuality=parseFloat(G.value),!a.croppedCanvas)return;const t=await Q(a.croppedCanvas,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),e=URL.createObjectURL(t.blob);D.src=e,X.textContent=`Kích thước: ${Math.round(t.size/1024)}KB | Chất lượng: ${t.quality.toFixed(2)} | Rộng: ${a.croppedCanvas.width}px`}async function bt(){if(!a.croppedCanvas)return;const t=await Q(a.croppedCanvas,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),e=document.createElement("a");e.href=URL.createObjectURL(t.blob),e.download="receipt.jpg",e.click()}function Mt(){b(K,!1),b(V,!1),b(W,!0)}function Lt(){a.quadPreview&&S(a.quadPreview)}lt.addEventListener("click",gt);dt.addEventListener("click",wt);$.addEventListener("change",H);U.addEventListener("change",H);vt.addEventListener("click",Ct);G.addEventListener("input",xt);ht.addEventListener("click",bt);mt.addEventListener("click",Mt);pt.addEventListener("click",Lt);P("Sẵn sàng");
