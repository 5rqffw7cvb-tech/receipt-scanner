(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const p of a.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function n(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function c(i){if(i.ep)return;i.ep=!0;const a=n(i);fetch(i.href,a)}})();let z=null;async function Y(){return z||(z=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=()=>{window.cv&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>t():t()},n.onerror=c=>e(new Error("Failed to load OpenCV.js")),document.head.appendChild(n)}),z)}const S=[];function A(t){return S.push(t),t}function J(){try{S.forEach(t=>t.delete())}catch{}S.length=0}async function Z(t,e){const{canny1:n=50,canny2:c=150,minAreaRatio:i=.15}=e||{},a=cv.imread(t),p=A(new cv.Mat);cv.cvtColor(a,p,cv.COLOR_RGBA2GRAY);const s=A(new cv.Mat);cv.GaussianBlur(p,s,new cv.Size(5,5),0);const r=A(new cv.Mat);cv.Canny(s,r,n,c);const w=cv.Mat.ones(3,3,cv.CV_8U),m=A(new cv.Mat);cv.dilate(r,m,w),w.delete();const y=new cv.MatVector,C=new cv.Mat;cv.findContours(m,y,C,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),C.delete();const f=a.rows*a.cols;let d=null;for(let g=0;g<y.size();g++){const b=y.get(g);if(cv.contourArea(b)<f*i){b.delete();continue}const E=cv.arcLength(b,!0),x=new cv.Mat;if(cv.approxPolyDP(b,x,.02*E,!0),x.rows===4){const R=[];for(let B=0;B<4;B++)R.push({x:x.intPtr(B,0)[0],y:x.intPtr(B,0)[1]});d=$(R),x.delete(),b.delete();break}x.delete(),b.delete()}return y.delete(),a.delete(),d?{quad:d}:null}function $(t){const e=t.map(s=>({p:s,s:s.x+s.y})).sort((s,r)=>s.s-r.s),n=t.map(s=>({p:s,d:s.x-s.y})).sort((s,r)=>s.d-r.d),c=e[0].p,i=e[3].p,a=n[3].p,p=n[0].p;return[c,a,i,p]}async function tt(t,e,n){const{scalePreviewToOriginal:c=1,maxOutputWidth:i=1600}=n||{},a=c,p=e.map(P=>({x:P.x*a,y:P.y*a})),s=cv.imread(t),r=$(p),w=q(r[0],r[1]),m=q(r[3],r[2]),y=q(r[0],r[3]),C=q(r[1],r[2]);let f=Math.max(w,m),d=Math.max(y,C);if(f>i){const P=i/f;f=i,d=Math.round(d*P)}const g=new cv.Size(Math.max(4,Math.round(f)),Math.max(4,Math.round(d))),b=cv.matFromArray(4,1,cv.CV_32FC2,r.flatMap(P=>[P.x,P.y])),j=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,g.width,0,g.width,g.height,0,g.height]),E=cv.getPerspectiveTransform(b,j),x=new cv.Mat;cv.warpPerspective(s,x,E,g,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);const R=document.createElement("canvas");return R.width=g.width,R.height=g.height,cv.imshow(R,x),s.delete(),b.delete(),j.delete(),E.delete(),x.delete(),{canvas:R}}function q(t,e){const n=t.x-e.x,c=t.y-e.y;return Math.hypot(n,c)}let l,u,T,h=null,I=-1;function et(t){l=t,u=l.getContext("2d"),l.addEventListener("pointerdown",ct),l.addEventListener("pointermove",rt),l.addEventListener("pointerup",_),l.addEventListener("pointercancel",_)}function nt(t){T=t,l.width=T.width,l.height=T.height,F()}function k(t){h=t.map(e=>({x:e.x,y:e.y})),F()}function at(){return h?h.map(t=>({x:t.x,y:t.y})):null}function F(){if(!(!u||!T)&&(u.clearRect(0,0,l.width,l.height),!!h)){u.strokeStyle="#10b981",u.lineWidth=2,u.beginPath(),u.moveTo(h[0].x,h[0].y),u.lineTo(h[1].x,h[1].y),u.lineTo(h[2].x,h[2].y),u.lineTo(h[3].x,h[3].y),u.closePath(),u.stroke();for(let t=0;t<4;t++)ot(h[t].x,h[t].y)}}function ot(t,e){u.fillStyle="#10b981",u.strokeStyle="#065f46",u.lineWidth=2,u.beginPath(),u.arc(t,e,8,0,Math.PI*2),u.fill(),u.stroke()}function it(t,e){if(!h)return-1;for(let n=0;n<4;n++){const c=h[n].x-t,i=h[n].y-e;if(Math.hypot(c,i)<=12)return n}return-1}function ct(t){const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),c=(t.clientY-e.top)*(l.height/e.height);I=it(n,c),I!==-1&&(l.setPointerCapture(t.pointerId),t.preventDefault())}function rt(t){if(I===-1)return;const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),c=(t.clientY-e.top)*(l.height/e.height);h[I].x=Math.max(0,Math.min(l.width,n)),h[I].y=Math.max(0,Math.min(l.height,c)),F()}function _(t){I!==-1&&l.releasePointerCapture(t.pointerId),I=-1}async function Q(t,e=.75,n=500,c=1600){let i=e,a=t;const p=(y,C)=>new Promise(f=>y.toBlob(d=>f(d),"image/jpeg",C)),s=async(y,C)=>{const f=await p(y,C),d=f.size;return{blob:f,size:d}};let{blob:r,size:w}=await s(a,i),m=0;for(;w>n*1024&&m<12;){if(m++,i>.5)i=Math.max(.4,i-.07);else{const C=Math.max(320,Math.round(a.width*.9)),f=Math.round(a.height*.9),d=document.createElement("canvas");d.width=Math.min(c,C),d.height=Math.round(f*(d.width/a.width)),d.getContext("2d").drawImage(a,0,0,d.width,d.height),a=d}const y=await s(a,i);r=y.blob,w=y.size}return{blob:r,size:w,quality:i}}const o={targetWidth:1280,canny1:30,canny2:100,minContourAreaRatio:.08,jpegQuality:.75,sizeLimitKB:500,maxOutputWidth:1600,cvReady:!1,imageBitmap:null,originalCanvas:null,scale:1,quadPreview:null,croppedCanvas:null},v=t=>document.getElementById(t),st=v("status"),K=v("cameraInput"),U=v("galleryInput"),lt=v("cameraBtn"),dt=v("galleryBtn"),O=v("previewCanvas"),ut=v("overlayCanvas"),N=v("resultSection"),D=v("resultImg"),W=v("adjustControls"),V=v("outputControls"),G=v("qualitySlider"),ht=v("downloadBtn"),X=v("sizeInfo"),pt=v("resetCorners"),vt=v("applyCrop"),mt=v("backBtn");function L(t){st.textContent=t}function M(t,e){t.classList.toggle("hidden",!e)}async function yt(){o.cvReady||(L("Loading OpenCV…"),await Y(),o.cvReady=!0,L("OpenCV ready"))}async function ft(){K.click()}async function gt(){U.click()}async function H(t){var w;const e=(w=t.target.files)==null?void 0:w[0];if(!e)return;M(N,!1),M(W,!1),M(V,!1),await yt(),L("Processing…");const n=await createImageBitmap(e);o.imageBitmap=n;const c=document.createElement("canvas");c.width=n.width,c.height=n.height,c.getContext("2d").drawImage(n,0,0),o.originalCanvas=c,o.targetWidth/n.width;const a=Math.min(o.targetWidth,n.width),p=Math.round(n.height*(a/n.width));O.width=a,O.height=p,O.getContext("2d").drawImage(n,0,0,a,p),o.scale=a/n.width;let r=null;try{const m=await Z(O,{canny1:o.canny1,canny2:o.canny2,minAreaRatio:o.minContourAreaRatio});r=(m==null?void 0:m.quad)||null}catch(m){console.error(m)}finally{J()}if(et(ut),nt(O),r)k(r),o.quadPreview=r,L("Preview detected. Adjust if needed.");else{const m=[{x:10,y:10},{x:a-10,y:10},{x:a-10,y:p-10},{x:10,y:p-10}];k(m),o.quadPreview=m,L("Không tìm thấy biên hóa đơn, vui lòng chỉnh tay.")}M(W,!0)}async function wt(){const t=at();o.quadPreview=t,L("Cropping…");const{canvas:e}=await tt(o.originalCanvas,t,{scalePreviewToOriginal:1/o.scale,maxOutputWidth:o.maxOutputWidth});o.croppedCanvas=e;const n=await Q(e,o.jpegQuality,o.sizeLimitKB,o.maxOutputWidth),c=URL.createObjectURL(n.blob);D.src=c,M(N,!0),M(V,!0),X.textContent=`Size: ${Math.round(n.size/1024)}KB, quality: ${n.quality.toFixed(2)}, width: ${e.width}`,L("Result preview")}async function Ct(){if(o.jpegQuality=parseFloat(G.value),!o.croppedCanvas)return;const t=await Q(o.croppedCanvas,o.jpegQuality,o.sizeLimitKB,o.maxOutputWidth),e=URL.createObjectURL(t.blob);D.src=e,X.textContent=`Size: ${Math.round(t.size/1024)}KB, quality: ${t.quality.toFixed(2)}, width: ${o.croppedCanvas.width}`}async function xt(){if(!o.croppedCanvas)return;const t=await Q(o.croppedCanvas,o.jpegQuality,o.sizeLimitKB,o.maxOutputWidth),e=document.createElement("a");e.href=URL.createObjectURL(t.blob),e.download="receipt.jpg",e.click()}function bt(){M(N,!1),M(V,!1),M(W,!0)}function Mt(){o.quadPreview&&k(o.quadPreview)}lt.addEventListener("click",ft);dt.addEventListener("click",gt);K.addEventListener("change",H);U.addEventListener("change",H);vt.addEventListener("click",wt);G.addEventListener("input",Ct);ht.addEventListener("click",xt);mt.addEventListener("click",bt);pt.addEventListener("click",Mt);L("Idle");
