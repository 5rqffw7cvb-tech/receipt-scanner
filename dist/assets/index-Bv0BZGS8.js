(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))c(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();let z=null;async function X(){return z||(z=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=()=>{window.cv&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>t():t()},n.onerror=c=>e(new Error("Failed to load OpenCV.js")),document.head.appendChild(n)}),z)}const S=[];function A(t){return S.push(t),t}function H(){try{S.forEach(t=>t.delete())}catch{}S.length=0}async function Y(t,e){const{canny1:n=50,canny2:c=150,minAreaRatio:a=.15}=e||{},o=cv.imread(t),p=A(new cv.Mat);cv.cvtColor(o,p,cv.COLOR_RGBA2GRAY);const s=A(new cv.Mat);cv.GaussianBlur(p,s,new cv.Size(5,5),0);const r=A(new cv.Mat);cv.Canny(s,r,n,c);const g=cv.Mat.ones(3,3,cv.CV_8U),v=A(new cv.Mat);cv.dilate(r,v,g),g.delete();const y=new cv.MatVector,C=new cv.Mat;cv.findContours(v,y,C,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),C.delete();const m=o.rows*o.cols;let l=null;for(let w=0;w<y.size();w++){const b=y.get(w);if(cv.contourArea(b)<m*a){b.delete();continue}const I=cv.arcLength(b,!0),x=new cv.Mat;if(cv.approxPolyDP(b,x,.02*I,!0),x.rows===4){const R=[];for(let B=0;B<4;B++)R.push({x:x.intPtr(B,0)[0],y:x.intPtr(B,0)[1]});l=$(R),x.delete(),b.delete();break}x.delete(),b.delete()}return y.delete(),o.delete(),l?{quad:l}:null}function $(t){const e=t.map(s=>({p:s,s:s.x+s.y})).sort((s,r)=>s.s-r.s),n=t.map(s=>({p:s,d:s.x-s.y})).sort((s,r)=>s.d-r.d),c=e[0].p,a=e[3].p,o=n[3].p,p=n[0].p;return[c,o,a,p]}async function J(t,e,n){const{scalePreviewToOriginal:c=1,maxOutputWidth:a=1600}=n||{},o=c,p=e.map(P=>({x:P.x*o,y:P.y*o})),s=cv.imread(t),r=$(p),g=q(r[0],r[1]),v=q(r[3],r[2]),y=q(r[0],r[3]),C=q(r[1],r[2]);let m=Math.max(g,v),l=Math.max(y,C);if(m>a){const P=a/m;m=a,l=Math.round(l*P)}const w=new cv.Size(Math.max(4,Math.round(m)),Math.max(4,Math.round(l))),b=cv.matFromArray(4,1,cv.CV_32FC2,r.flatMap(P=>[P.x,P.y])),j=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,w.width,0,w.width,w.height,0,w.height]),I=cv.getPerspectiveTransform(b,j),x=new cv.Mat;cv.warpPerspective(s,x,I,w,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);const R=document.createElement("canvas");return R.width=w.width,R.height=w.height,cv.imshow(R,x),s.delete(),b.delete(),j.delete(),I.delete(),x.delete(),{canvas:R}}function q(t,e){const n=t.x-e.x,c=t.y-e.y;return Math.hypot(n,c)}let d,u,T,h=null,O=-1;function Z(t){d=t,u=d.getContext("2d"),d.addEventListener("pointerdown",it),d.addEventListener("pointermove",at),d.addEventListener("pointerup",_),d.addEventListener("pointercancel",_)}function tt(t){T=t,d.width=T.width,d.height=T.height,Q()}function k(t){h=t.map(e=>({x:e.x,y:e.y})),Q()}function et(){return h?h.map(t=>({x:t.x,y:t.y})):null}function Q(){if(!(!u||!T)&&(u.clearRect(0,0,d.width,d.height),!!h)){u.strokeStyle="#10b981",u.lineWidth=2,u.beginPath(),u.moveTo(h[0].x,h[0].y),u.lineTo(h[1].x,h[1].y),u.lineTo(h[2].x,h[2].y),u.lineTo(h[3].x,h[3].y),u.closePath(),u.stroke();for(let t=0;t<4;t++)nt(h[t].x,h[t].y)}}function nt(t,e){u.fillStyle="#10b981",u.strokeStyle="#065f46",u.lineWidth=2,u.beginPath(),u.arc(t,e,8,0,Math.PI*2),u.fill(),u.stroke()}function ot(t,e){if(!h)return-1;for(let n=0;n<4;n++){const c=h[n].x-t,a=h[n].y-e;if(Math.hypot(c,a)<=12)return n}return-1}function it(t){const e=d.getBoundingClientRect(),n=(t.clientX-e.left)*(d.width/e.width),c=(t.clientY-e.top)*(d.height/e.height);O=ot(n,c),O!==-1&&(d.setPointerCapture(t.pointerId),t.preventDefault())}function at(t){if(O===-1)return;const e=d.getBoundingClientRect(),n=(t.clientX-e.left)*(d.width/e.width),c=(t.clientY-e.top)*(d.height/e.height);h[O].x=Math.max(0,Math.min(d.width,n)),h[O].y=Math.max(0,Math.min(d.height,c)),Q()}function _(t){O!==-1&&d.releasePointerCapture(t.pointerId),O=-1}async function F(t,e=.75,n=500,c=1600){let a=e,o=t;const p=(y,C)=>new Promise(m=>y.toBlob(l=>m(l),"image/jpeg",C)),s=async(y,C)=>{const m=await p(y,C),l=m.size;return{blob:m,size:l}};let{blob:r,size:g}=await s(o,a),v=0;for(;g>n*1024&&v<12;){if(v++,a>.5)a=Math.max(.4,a-.07);else{const C=Math.max(320,Math.round(o.width*.9)),m=Math.round(o.height*.9),l=document.createElement("canvas");l.width=Math.min(c,C),l.height=Math.round(m*(l.width/o.width)),l.getContext("2d").drawImage(o,0,0,l.width,l.height),o=l}const y=await s(o,a);r=y.blob,g=y.size}return{blob:r,size:g,quality:a}}const i={targetWidth:1280,canny1:50,canny2:150,minContourAreaRatio:.15,jpegQuality:.75,sizeLimitKB:500,maxOutputWidth:1600,cvReady:!1,imageBitmap:null,originalCanvas:null,scale:1,quadPreview:null,croppedCanvas:null},f=t=>document.getElementById(t),ct=f("status"),K=f("fileInput"),rt=f("pickBtn"),E=f("previewCanvas"),st=f("overlayCanvas"),N=f("resultSection"),U=f("resultImg"),W=f("adjustControls"),V=f("outputControls"),D=f("qualitySlider"),dt=f("downloadBtn"),G=f("sizeInfo"),lt=f("resetCorners"),ut=f("applyCrop"),ht=f("backBtn");function L(t){ct.textContent=t}function M(t,e){t.classList.toggle("hidden",!e)}async function pt(){i.cvReady||(L("Loading OpenCV…"),await X(),i.cvReady=!0,L("OpenCV ready"))}async function vt(){K.click()}async function ft(t){var g;const e=(g=t.target.files)==null?void 0:g[0];if(!e)return;M(N,!1),M(W,!1),M(V,!1),await pt(),L("Processing…");const n=await createImageBitmap(e);i.imageBitmap=n;const c=document.createElement("canvas");c.width=n.width,c.height=n.height,c.getContext("2d").drawImage(n,0,0),i.originalCanvas=c,i.targetWidth/n.width;const o=Math.min(i.targetWidth,n.width),p=Math.round(n.height*(o/n.width));E.width=o,E.height=p,E.getContext("2d").drawImage(n,0,0,o,p),i.scale=o/n.width;let r=null;try{const v=await Y(E,{canny1:i.canny1,canny2:i.canny2,minAreaRatio:i.minContourAreaRatio});r=(v==null?void 0:v.quad)||null}catch(v){console.error(v)}finally{H()}if(Z(st),tt(E),r)k(r),i.quadPreview=r,L("Preview detected. Adjust if needed.");else{const v=[{x:10,y:10},{x:o-10,y:10},{x:o-10,y:p-10},{x:10,y:p-10}];k(v),i.quadPreview=v,L("Không tìm thấy biên hóa đơn, vui lòng chỉnh tay.")}M(W,!0)}async function yt(){const t=et();i.quadPreview=t,L("Cropping…");const{canvas:e}=await J(i.originalCanvas,t,{scalePreviewToOriginal:1/i.scale,maxOutputWidth:i.maxOutputWidth});i.croppedCanvas=e;const n=await F(e,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),c=URL.createObjectURL(n.blob);U.src=c,M(N,!0),M(V,!0),G.textContent=`Size: ${Math.round(n.size/1024)}KB, quality: ${n.quality.toFixed(2)}, width: ${e.width}`,L("Result preview")}async function mt(){if(i.jpegQuality=parseFloat(D.value),!i.croppedCanvas)return;const t=await F(i.croppedCanvas,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),e=URL.createObjectURL(t.blob);U.src=e,G.textContent=`Size: ${Math.round(t.size/1024)}KB, quality: ${t.quality.toFixed(2)}, width: ${i.croppedCanvas.width}`}async function wt(){if(!i.croppedCanvas)return;const t=await F(i.croppedCanvas,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),e=document.createElement("a");e.href=URL.createObjectURL(t.blob),e.download="receipt.jpg",e.click()}function gt(){M(N,!1),M(V,!1),M(W,!0)}function Ct(){i.quadPreview&&k(i.quadPreview)}rt.addEventListener("click",vt);K.addEventListener("change",ft);ut.addEventListener("click",yt);D.addEventListener("input",mt);dt.addEventListener("click",wt);ht.addEventListener("click",gt);lt.addEventListener("click",Ct);L("Idle");
