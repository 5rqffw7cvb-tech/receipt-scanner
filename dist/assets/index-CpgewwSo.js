(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const v of c.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&o(v)}).observe(document,{childList:!0,subtree:!0});function n(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(a){if(a.ep)return;a.ep=!0;const c=n(a);fetch(a.href,c)}})();let T=null;async function Y(){return T||(T=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=()=>{window.cv&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>t():t()},n.onerror=o=>e(new Error("Failed to load OpenCV.js")),document.head.appendChild(n)}),T)}const j=[];function I(t){return j.push(t),t}function J(){try{j.forEach(t=>t.delete())}catch{}j.length=0}async function Z(t,e){const{minAreaRatio:n=.15}=e||{},o=cv.imread(t),a=I(new cv.Mat);cv.cvtColor(o,a,cv.COLOR_RGBA2GRAY);const c=I(new cv.Mat);cv.adaptiveThreshold(a,c,255,cv.ADAPTIVE_THRESH_GAUSSIAN_C,cv.THRESH_BINARY,11,2);const v=I(new cv.Mat);cv.bitwise_not(c,v);const l=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(5,5)),r=I(new cv.Mat);cv.morphologyEx(v,r,cv.MORPH_CLOSE,l);const w=I(new cv.Mat);cv.morphologyEx(r,w,cv.MORPH_OPEN,l),l.delete();const h=new cv.MatVector,C=new cv.Mat;cv.findContours(w,h,C,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),C.delete();const b=o.rows*o.cols;let m=null,p=0;for(let g=0;g<h.size();g++){const R=h.get(g),O=cv.contourArea(R);if(O<b*n){R.delete();continue}const A=cv.arcLength(R,!0),M=new cv.Mat;if(cv.approxPolyDP(R,M,.02*A,!0),M.rows===4){const L=[];for(let y=0;y<4;y++)L.push({x:M.intPtr(y,0)[0],y:M.intPtr(y,0)[1]});O>p&&(m=Q(L),p=O)}M.delete(),R.delete()}return h.delete(),o.delete(),m?{quad:m}:null}function Q(t){const e=t.map(l=>({p:l,s:l.x+l.y})).sort((l,r)=>l.s-r.s),n=t.map(l=>({p:l,d:l.x-l.y})).sort((l,r)=>l.d-r.d),o=e[0].p,a=e[3].p,c=n[3].p,v=n[0].p;return[o,c,a,v]}async function tt(t,e,n){const{scalePreviewToOriginal:o=1,maxOutputWidth:a=1600}=n||{},c=o,v=e.map(y=>({x:y.x*c,y:y.y*c})),l=cv.imread(t),r=Q(v),w=S(r[0],r[1]),h=S(r[3],r[2]),C=S(r[0],r[3]),b=S(r[1],r[2]);let m=Math.max(w,h),p=Math.max(C,b);if(m>a){const y=a/m;m=a,p=Math.round(p*y)}const g=new cv.Size(Math.max(4,Math.round(m)),Math.max(4,Math.round(p))),R=cv.matFromArray(4,1,cv.CV_32FC2,r.flatMap(y=>[y.x,y.y])),O=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,g.width,0,g.width,g.height,0,g.height]),A=cv.getPerspectiveTransform(R,O),M=new cv.Mat;cv.warpPerspective(l,M,A,g,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);const L=document.createElement("canvas");return L.width=g.width,L.height=g.height,cv.imshow(L,M),l.delete(),R.delete(),O.delete(),A.delete(),M.delete(),{canvas:L}}function S(t,e){const n=t.x-e.x,o=t.y-e.y;return Math.hypot(n,o)}let s,d,z,u=null,P=-1;function et(t){s=t,d=s.getContext("2d"),s.addEventListener("pointerdown",ct),s.addEventListener("pointermove",it),s.addEventListener("pointerup",N),s.addEventListener("pointercancel",N)}function nt(t){z=t,s.width=z.width,s.height=z.height,_()}function k(t){u=t.map(e=>({x:e.x,y:e.y})),_()}function ot(){return u?u.map(t=>({x:t.x,y:t.y})):null}function _(){if(!(!d||!z)&&(d.clearRect(0,0,s.width,s.height),!!u)){d.strokeStyle="#3b82f6",d.lineWidth=3,d.beginPath(),d.moveTo(u[0].x,u[0].y),d.lineTo(u[1].x,u[1].y),d.lineTo(u[2].x,u[2].y),d.lineTo(u[3].x,u[3].y),d.closePath(),d.stroke();for(let t=0;t<4;t++){const e=P===t;at(u[t].x,u[t].y,e)}}}function at(t,e,n){const o=n?16:12;d.fillStyle=n?"#2563eb":"#3b82f6",d.strokeStyle="#fff",d.lineWidth=2,d.beginPath(),d.arc(t,e,o,0,Math.PI*2),d.fill(),d.stroke()}function K(t,e){if(!u)return-1;const n=24;for(let o=0;o<4;o++){const a=u[o].x-t,c=u[o].y-e;if(Math.hypot(a,c)<=n)return o}return-1}function ct(t){const e=s.getBoundingClientRect(),n=(t.clientX-e.left)*(s.width/e.width),o=(t.clientY-e.top)*(s.height/e.height);P=K(n,o),P!==-1&&(s.setPointerCapture(t.pointerId),s.style.cursor="grabbing",t.preventDefault())}function it(t){const e=s.getBoundingClientRect(),n=(t.clientX-e.left)*(s.width/e.width),o=(t.clientY-e.top)*(s.height/e.height);if(P===-1){const a=K(n,o);s.style.cursor=a!==-1?"grab":"default"}P!==-1&&(u[P].x=Math.max(0,Math.min(s.width,n)),u[P].y=Math.max(0,Math.min(s.height,o)),_())}function N(t){P!==-1&&(s.releasePointerCapture(t.pointerId),s.style.cursor="default"),P=-1}async function W(t,e=.75,n=500,o=1600){let a=e,c=t;const v=(C,b)=>new Promise(m=>C.toBlob(p=>m(p),"image/jpeg",b)),l=async(C,b)=>{const m=await v(C,b),p=m.size;return{blob:m,size:p}};let{blob:r,size:w}=await l(c,a),h=0;for(;w>n*1024&&h<12;){if(h++,a>.5)a=Math.max(.4,a-.07);else{const b=Math.max(320,Math.round(c.width*.9)),m=Math.round(c.height*.9),p=document.createElement("canvas");p.width=Math.min(o,b),p.height=Math.round(m*(p.width/c.width)),p.getContext("2d").drawImage(c,0,0,p.width,p.height),c=p}const C=await l(c,a);r=C.blob,w=C.size}return{blob:r,size:w,quality:a}}const i={targetWidth:1280,canny1:30,canny2:100,minContourAreaRatio:.08,jpegQuality:.75,sizeLimitKB:500,maxOutputWidth:1600,cvReady:!1,imageBitmap:null,originalCanvas:null,scale:1,quadPreview:null,croppedCanvas:null},f=t=>document.getElementById(t),rt=f("status"),V=f("cameraInput"),$=f("galleryInput"),st=f("cameraBtn"),lt=f("galleryBtn"),B=f("previewCanvas"),dt=f("overlayCanvas"),F=f("resultSection"),U=f("resultImg"),q=f("adjustControls"),H=f("outputControls"),D=f("qualitySlider"),ut=f("downloadBtn"),G=f("sizeInfo"),ht=f("resetCorners"),pt=f("applyCrop"),vt=f("backBtn");function E(t){rt.textContent=t}function x(t,e){t.classList.toggle("hidden",!e)}async function ft(){try{const e=await(await fetch("/package.json")).json();document.getElementById("version").textContent="v"+e.version}catch{console.log("Could not load version")}}ft();async function mt(){i.cvReady||(E("Loading OpenCV…"),await Y(),i.cvReady=!0,E("OpenCV ready"))}async function gt(){V.click()}async function yt(){$.click()}async function X(t){var w;const e=(w=t.target.files)==null?void 0:w[0];if(!e)return;x(F,!1),x(q,!1),x(H,!1),x(previewSection,!0),await mt(),E("Xử lý…");const n=await createImageBitmap(e);i.imageBitmap=n;const o=document.createElement("canvas");o.width=n.width,o.height=n.height,o.getContext("2d").drawImage(n,0,0),i.originalCanvas=o,i.targetWidth/n.width;const c=Math.min(i.targetWidth,n.width),v=Math.round(n.height*(c/n.width));B.width=c,B.height=v,B.getContext("2d").drawImage(n,0,0,c,v),i.scale=c/n.width;let r=null;try{const h=await Z(B,{canny1:i.canny1,canny2:i.canny2,minAreaRatio:i.minContourAreaRatio});r=(h==null?void 0:h.quad)||null}catch(h){console.error(h)}finally{J()}if(et(dt),nt(B),r)k(r),i.quadPreview=r,E("Đã phát hiện. Chỉnh nếu cần.");else{const h=[{x:10,y:10},{x:c-10,y:10},{x:c-10,y:v-10},{x:10,y:v-10}];k(h),i.quadPreview=h,E("Không tìm được biên, vui lòng chỉnh tay.")}x(q,!0)}async function wt(){const t=ot();i.quadPreview=t,E("Đang cắt…");const{canvas:e}=await tt(i.originalCanvas,t,{scalePreviewToOriginal:1/i.scale,maxOutputWidth:i.maxOutputWidth});i.croppedCanvas=e;const n=await W(e,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),o=URL.createObjectURL(n.blob);U.src=o,x(F,!0),x(H,!0),G.textContent=`Kích thước: ${Math.round(n.size/1024)}KB | Chất lượng: ${n.quality.toFixed(2)} | Rộng: ${e.width}px`,E("Hoàn thành")}async function Ct(){if(i.jpegQuality=parseFloat(D.value),!i.croppedCanvas)return;const t=await W(i.croppedCanvas,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),e=URL.createObjectURL(t.blob);U.src=e,G.textContent=`Kích thước: ${Math.round(t.size/1024)}KB | Chất lượng: ${t.quality.toFixed(2)} | Rộng: ${i.croppedCanvas.width}px`}async function xt(){if(!i.croppedCanvas)return;const t=await W(i.croppedCanvas,i.jpegQuality,i.sizeLimitKB,i.maxOutputWidth),e=document.createElement("a");e.href=URL.createObjectURL(t.blob),e.download="receipt.jpg",e.click()}function bt(){x(F,!1),x(H,!1),x(q,!0)}function Mt(){i.quadPreview&&k(i.quadPreview)}st.addEventListener("click",gt);lt.addEventListener("click",yt);V.addEventListener("change",X);$.addEventListener("change",X);pt.addEventListener("click",wt);D.addEventListener("input",Ct);ut.addEventListener("click",xt);vt.addEventListener("click",bt);ht.addEventListener("click",Mt);E("Sẵn sàng");
