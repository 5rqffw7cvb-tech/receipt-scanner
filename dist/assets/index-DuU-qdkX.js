(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))c(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const p of o.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function c(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();let A=null;async function X(){return A||(A=new Promise((t,e)=>{const n=document.createElement("script");n.src="https://docs.opencv.org/4.x/opencv.js",n.async=!0,n.onload=()=>{window.cv&&cv.onRuntimeInitialized?cv.onRuntimeInitialized=()=>t():t()},n.onerror=c=>e(new Error("Failed to load OpenCV.js")),document.head.appendChild(n)}),A)}const S=[];function q(t){return S.push(t),t}function H(){try{S.forEach(t=>t.delete())}catch{}S.length=0}async function Y(t,e){const{canny1:n=50,canny2:c=150,minAreaRatio:i=.15}=e||{},o=cv.imread(t),p=q(new cv.Mat);cv.cvtColor(o,p,cv.COLOR_RGBA2GRAY);const s=q(new cv.Mat);cv.GaussianBlur(p,s,new cv.Size(5,5),0);const r=q(new cv.Mat);cv.Canny(s,r,n,c);const w=cv.Mat.ones(3,3,cv.CV_8U),f=q(new cv.Mat);cv.dilate(r,f,w),w.delete();const m=new cv.MatVector,C=new cv.Mat;cv.findContours(f,m,C,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),C.delete();const y=o.rows*o.cols;let d=null;for(let g=0;g<m.size();g++){const b=m.get(g);if(cv.contourArea(b)<y*i){b.delete();continue}const B=cv.arcLength(b,!0),x=new cv.Mat;if(cv.approxPolyDP(b,x,.02*B,!0),x.rows===4){const R=[];for(let z=0;z<4;z++)R.push({x:x.intPtr(z,0)[0],y:x.intPtr(z,0)[1]});d=K(R),x.delete(),b.delete();break}x.delete(),b.delete()}return m.delete(),o.delete(),d?{quad:d}:null}function K(t){const e=t.map(s=>({p:s,s:s.x+s.y})).sort((s,r)=>s.s-r.s),n=t.map(s=>({p:s,d:s.x-s.y})).sort((s,r)=>s.d-r.d),c=e[0].p,i=e[3].p,o=n[3].p,p=n[0].p;return[c,o,i,p]}async function J(t,e,n){const{scalePreviewToOriginal:c=1,maxOutputWidth:i=1600}=n||{},o=c,p=e.map(P=>({x:P.x*o,y:P.y*o})),s=cv.imread(t),r=K(p),w=T(r[0],r[1]),f=T(r[3],r[2]),m=T(r[0],r[3]),C=T(r[1],r[2]);let y=Math.max(w,f),d=Math.max(m,C);if(y>i){const P=i/y;y=i,d=Math.round(d*P)}const g=new cv.Size(Math.max(4,Math.round(y)),Math.max(4,Math.round(d))),b=cv.matFromArray(4,1,cv.CV_32FC2,r.flatMap(P=>[P.x,P.y])),j=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,g.width,0,g.width,g.height,0,g.height]),B=cv.getPerspectiveTransform(b,j),x=new cv.Mat;cv.warpPerspective(s,x,B,g,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);const R=document.createElement("canvas");return R.width=g.width,R.height=g.height,cv.imshow(R,x),s.delete(),b.delete(),j.delete(),B.delete(),x.delete(),{canvas:R}}function T(t,e){const n=t.x-e.x,c=t.y-e.y;return Math.hypot(n,c)}let l,u,k,h=null,O=-1;function Z(t){l=t,u=l.getContext("2d"),l.addEventListener("pointerdown",at),l.addEventListener("pointermove",it),l.addEventListener("pointerup",$),l.addEventListener("pointercancel",$)}function tt(t){k=t,l.width=k.width,l.height=k.height,Q()}function F(t){h=t.map(e=>({x:e.x,y:e.y})),Q()}function et(){return h?h.map(t=>({x:t.x,y:t.y})):null}function Q(){if(!(!u||!k)&&(u.clearRect(0,0,l.width,l.height),!!h)){u.strokeStyle="#10b981",u.lineWidth=2,u.beginPath(),u.moveTo(h[0].x,h[0].y),u.lineTo(h[1].x,h[1].y),u.lineTo(h[2].x,h[2].y),u.lineTo(h[3].x,h[3].y),u.closePath(),u.stroke();for(let t=0;t<4;t++)nt(h[t].x,h[t].y)}}function nt(t,e){u.fillStyle="#10b981",u.strokeStyle="#065f46",u.lineWidth=2,u.beginPath(),u.arc(t,e,8,0,Math.PI*2),u.fill(),u.stroke()}function ot(t,e){if(!h)return-1;for(let n=0;n<4;n++){const c=h[n].x-t,i=h[n].y-e;if(Math.hypot(c,i)<=12)return n}return-1}function at(t){const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),c=(t.clientY-e.top)*(l.height/e.height);O=ot(n,c),O!==-1&&(l.setPointerCapture(t.pointerId),t.preventDefault())}function it(t){if(O===-1)return;const e=l.getBoundingClientRect(),n=(t.clientX-e.left)*(l.width/e.width),c=(t.clientY-e.top)*(l.height/e.height);h[O].x=Math.max(0,Math.min(l.width,n)),h[O].y=Math.max(0,Math.min(l.height,c)),Q()}function $(t){O!==-1&&l.releasePointerCapture(t.pointerId),O=-1}async function N(t,e=.75,n=500,c=1600){let i=e,o=t;const p=(m,C)=>new Promise(y=>m.toBlob(d=>y(d),"image/jpeg",C)),s=async(m,C)=>{const y=await p(m,C),d=y.size;return{blob:y,size:d}};let{blob:r,size:w}=await s(o,i),f=0;for(;w>n*1024&&f<12;){if(f++,i>.5)i=Math.max(.4,i-.07);else{const C=Math.max(320,Math.round(o.width*.9)),y=Math.round(o.height*.9),d=document.createElement("canvas");d.width=Math.min(c,C),d.height=Math.round(y*(d.width/o.width)),d.getContext("2d").drawImage(o,0,0,d.width,d.height),o=d}const m=await s(o,i);r=m.blob,w=m.size}return{blob:r,size:w,quality:i}}const a={targetWidth:1280,canny1:50,canny2:150,minContourAreaRatio:.15,jpegQuality:.75,sizeLimitKB:500,maxOutputWidth:1600,cvReady:!1,imageBitmap:null,originalCanvas:null,scale:1,quadPreview:null,croppedCanvas:null},v=t=>document.getElementById(t),ct=v("status"),E=v("fileInput"),rt=v("cameraBtn"),st=v("galleryBtn"),I=v("previewCanvas"),lt=v("overlayCanvas"),V=v("resultSection"),U=v("resultImg"),W=v("adjustControls"),_=v("outputControls"),D=v("qualitySlider"),dt=v("downloadBtn"),G=v("sizeInfo"),ut=v("resetCorners"),ht=v("applyCrop"),pt=v("backBtn");function L(t){ct.textContent=t}function M(t,e){t.classList.toggle("hidden",!e)}async function ft(){a.cvReady||(L("Loading OpenCV‚Ä¶"),await X(),a.cvReady=!0,L("OpenCV ready"))}async function vt(){console.log("üì∑ Camera button clicked"),E.accept="image/*",E.capture="environment",E.click()}async function mt(){console.log("üñºÔ∏è Gallery button clicked"),E.accept="image/*",E.capture="",E.click()}async function yt(t){var w;console.log("File selected:",t.target.files);const e=(w=t.target.files)==null?void 0:w[0];if(!e){console.log("No file");return}M(V,!1),M(W,!1),M(_,!1),await ft(),L("Processing‚Ä¶");const n=await createImageBitmap(e);a.imageBitmap=n;const c=document.createElement("canvas");c.width=n.width,c.height=n.height,c.getContext("2d").drawImage(n,0,0),a.originalCanvas=c,a.targetWidth/n.width;const o=Math.min(a.targetWidth,n.width),p=Math.round(n.height*(o/n.width));I.width=o,I.height=p,I.getContext("2d").drawImage(n,0,0,o,p),a.scale=o/n.width;let r=null;try{const f=await Y(I,{canny1:a.canny1,canny2:a.canny2,minAreaRatio:a.minContourAreaRatio});r=(f==null?void 0:f.quad)||null}catch(f){console.error(f)}finally{H()}if(Z(lt),tt(I),r)F(r),a.quadPreview=r,L("Preview detected. Adjust if needed.");else{const f=[{x:10,y:10},{x:o-10,y:10},{x:o-10,y:p-10},{x:10,y:p-10}];F(f),a.quadPreview=f,L("Kh√¥ng t√¨m th·∫•y bi√™n h√≥a ƒë∆°n, vui l√≤ng ch·ªânh tay.")}M(W,!0)}async function gt(){const t=et();a.quadPreview=t,L("Cropping‚Ä¶");const{canvas:e}=await J(a.originalCanvas,t,{scalePreviewToOriginal:1/a.scale,maxOutputWidth:a.maxOutputWidth});a.croppedCanvas=e;const n=await N(e,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),c=URL.createObjectURL(n.blob);U.src=c,M(V,!0),M(_,!0),G.textContent=`Size: ${Math.round(n.size/1024)}KB, quality: ${n.quality.toFixed(2)}, width: ${e.width}`,L("Result preview")}async function wt(){if(a.jpegQuality=parseFloat(D.value),!a.croppedCanvas)return;const t=await N(a.croppedCanvas,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),e=URL.createObjectURL(t.blob);U.src=e,G.textContent=`Size: ${Math.round(t.size/1024)}KB, quality: ${t.quality.toFixed(2)}, width: ${a.croppedCanvas.width}`}async function Ct(){if(!a.croppedCanvas)return;const t=await N(a.croppedCanvas,a.jpegQuality,a.sizeLimitKB,a.maxOutputWidth),e=document.createElement("a");e.href=URL.createObjectURL(t.blob),e.download="receipt.jpg",e.click()}function xt(){M(V,!1),M(_,!1),M(W,!0)}function bt(){a.quadPreview&&F(a.quadPreview)}rt.addEventListener("click",vt);st.addEventListener("click",mt);E.addEventListener("change",yt);ht.addEventListener("click",gt);D.addEventListener("input",wt);dt.addEventListener("click",Ct);pt.addEventListener("click",xt);ut.addEventListener("click",bt);L("Idle");
